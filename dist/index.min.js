"use strict";var Parse=require("parse"),ParseCCMixin={componentWillMount:function(){if(this._subscriptions={},this.data=this.data||{},this._pendingQueries={},this._queryErrors={},!this.loadData)throw new Error("Components using ParseCCMixin must declare a loadData() method.");this._subscribe(this.props,this.state)},componentWillUpdate:function(t,i){(t!==this.props||i!==this.state)&&this._resubscribe(t,i)},componentWillUnmount:function(){this._unsubscribe()},pendingQueries:function(){var t=[];for(var i in this._pendingQueries)this._pendingQueries[i]&&t.push(i);return t},queryErrors:function(){if(Object.keys(this._queryErrors).length<1)return null;var t={};for(var i in this._queryErrors)t[i]=this._queryErrors[i];return t},reloadData:function(t){this._subscribe(this.props,this.state,t)},_subscribe:function(t,i,s){var r=this.loadData(t,i),e={};for(var n in r)s&&-1==s.indexOf(n)||r[n]&&(this.data[n]=this.data[n]||r[n].defaultValue,e[n]=this._getData(n,r[n]));this._unsubscribe(),this._subscriptions=e},_resubscribe:function(t,i){var s=this.loadData(t,i),r={};for(var e in s)if(s[e]){var n=s[e].propDeps,a=s[e].stateDeps,o=function(t){return t&&t.constructor===Array};o(n)||o(a)?this._didDepsChange(n,a,t,i)&&(r[e]=this._getData(e,s[e])):r[e]=this._getData(e,s[e])}this._unsubscribe(),this._subscriptions=r},_unsubscribe:function(){for(var t in this._subscriptions)Parse.Promise.reject(this._subscriptions[t]);this._subscriptions={}},_getData:function(t,i){var s=Date.now();return this._pendingQueries[t]=s,Parse.Cloud.run(i.name,i.params).then(function(i){s===this._pendingQueries[t]&&this._receiveData(t,i)}.bind(this),function(i){s===this._pendingQueries[t]&&this._receiveError(t,i)}.bind(this))},_receiveData:function(t,i){this.data[t]=i,delete this._pendingQueries[t],delete this._queryErrors[t],this.forceUpdate()},_receiveError:function(t,i){this._queryErrors[t]=i,this.forceUpdate()},_didDepsChange:function(t,i,s,r){t=t||[],i=i||[];for(var e=!1,n=0;n<t.length&&!e;n++){var a=t[n];this.props[a]!=s[a]&&(e=!0)}for(var n=0;n<i.length&&!e;n++){var a=i[n];this.state[a]!=r[a]&&(e=!0)}return e}};module.exports=ParseCCMixin;
